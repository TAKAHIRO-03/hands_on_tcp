# 成果報告書

## テーマ
TCPはなぜ普及しているのか？

or 

ハンズオンで学ぶTCP

## 序論
　TCPは一般的に信頼性が高く、UDPは信頼性は低いがデータを効率良く転送出来ると言われている。
TCPは世の中で使われているトランスポート層のプロトコルとして1番使用されており、その次はUDPである。
TCPが世界で普及している理由はなぜか、TCPとUDPを比較、両者の違いを検証環境を用いて通信、比較し、各プロトコルの違いを纏めていく。

https://archive.nanog.org/meetings/nanog43/presentations/Labovitz_internetstats_N43.pdf

## 本論
　信頼性を定量的に判断するために、このレポートの中では、「送信端末と宛先がネットワークを経由して、確実にパケットを送受信、かつ順序性が担保されていること」と定義する。
実際に検証時に使っているコマンド等は、実際に取り扱っているファイルは参考文献のURLを参考にすること。

以下のユースケースの時、TCPとUDPでどのような違いが出るのか？検証する内容は以下の通りである。
1. 送信端末から宛先にパケットを送信中に、通信の経路でルーターが再起動（一時的に停止）する。
  （フロー制御と輻輳制御）
2. 送信端末からパケットロスを意図的に起こし送信する。
3. 送信端末の送信パケットの順序を変更し宛先に送信する。

　次に検証する際に使用するシステム構成は以下の通りだ。

■ システム・ネットワーク構成
Sender ⇔ Router ⇔ Receiver
IPアドレスが書かれた図とブリッジ接続する旨を記載。

> 1. 送信端末から宛先にパケットを送信中に、通信の経路でルーターが再起動（一時的に停止）する。

検証方法は、TCPは500MBとUDPは3GBでメッセージを送信した図となる。
※ 送信データサイズが異なっているのは、UDPの送信時間が速く、ルーターを担っているコンテナの再起動前にデータ送信が終わってしまっていたため、
   送信データサイズを変更して検証を行っている。

送信メッセージの長さと時間を軸にグラフ化した図である。
この図から言えることとしては、TCPで送信し始めの時は、データ量が尻上がりに挙がっていき、ルーターが再起動した時に、
一度、送信データサイズが下がり、再度徐々にデータ量が上がっている。
これは、TCPの機能である、輻輳制御、フロー制御が機能していることが伺える。
それに対して、UDPの方は送信データサイズは一貫して一定であった。

> 2. 送信端末からパケットロスを意図的に起こし送信する。

tc qdisc add dev eth0 root pfifo_fast

## 結論
本論を基に、TCP信頼性が担保されたプロトコルであることが分かった。
過去の通信プロトコルでは、異なるノード間で通信を行うことや分散ネットワークの考え方が無かった旨、ネットワークの歴史等を纏め、
このことから、信頼性を重視しているプロトコルが普及したと言える。
そもそもそこまでの転送量が多くなかったから、効率はあまり重要ではなかったと考える。
未来のことも踏まえつつ

## 参考文献
Githubのリポジトリを貼る。

## パケロスの話
パケットロスについて見ていく。

```
[root@sender ~]# tcpdump -i eth0 -tttt -nn tcp port 10080 -w /root/volume/tcp.pcap
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
^C26311 packets captured
26311 packets received by filter
0 packets dropped by kernel
[root@sender ~]#
```

```
[root@sender ~]# tcpdump -i eth0 -tttt -nn udp port 10080 -w /root/volume/udp.pcap
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
^C518675 packets captured
1018407 packets received by filter
499732 packets dropped by kernel
```

こちらは、上部がTCPでパケットキャプチャをした時であり、下段がUDPの送受信時のパケットロスを表している。
TCPはルーターが再起動したのにも関わらず、パケットロスが発生していない。それに対して、UDPは、499732のパケットロスが起こっている。

実際に、パケットキャプチャの図は以下の通りである。
パケットのKeepAliveが起こり、しばらくしてから通信を開始し、Window Updateをしている通信している様子が伺える。
相手と一定時間通信が出来なくなっても、直ぐにコネクションは切断しないことが分かる。

